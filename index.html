<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Cost & Profit Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Neutrals -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FDFBF7;
            color: #374151;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 320px;
            }
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Interactive Profitability Calculator</h1>
            <p class="mt-2 text-lg text-gray-600">Adjust the inputs to dynamically calculate costs and profits.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            
            <section id="inputs" class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold mb-6 border-b pb-3 text-gray-700">Input Variables</h2>
                <div class="space-y-6">
                    <!-- Dynamic inputs for different sizes -->
                    <div class="mb-4">
                        <h3 class="text-xl font-semibold mb-3">Sizes & Factory Costs</h3>
                        <table class="w-full text-left table-auto border-collapse">
                            <thead>
                                <tr class="bg-gray-100 text-gray-600">
                                    <th class="p-2 border-b">Size</th>
                                    <th class="p-2 border-b">Qty</th>
                                    <th class="p-2 border-b">Factory Price (₹)</th>
                                    <!-- NEW COLUMN FOR SELLING PRICE -->
                                    <th class="p-2 border-b">Selling Price/pc (₹)</th>
                                    <th class="p-2 border-b"></th>
                                </tr>
                            </thead>
                            <tbody id="size-table-body">
                                <!-- Rows will be added here by JS -->
                            </tbody>
                        </table>
                        <div class="flex justify-end mt-4 space-x-2">
                             <button id="add-size-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors duration-200">
                                Add Size
                            </button>
                        </div>
                    </div>

                    <!-- Common Cost Inputs -->
                    <div class="space-y-6 mt-8">
                        <div>
                            <label for="gst_percent" class="block font-medium text-gray-700 mb-1">GST (%)</label>
                            <input type="number" id="gst_percent" min="0" max="50" step="1" value="0" class="border p-2 rounded-lg w-full text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="transport" class="block font-medium text-gray-700 mb-1">Transport (₹)</label>
                            <input type="number" id="transport" min="0" max="5000" step="10" value="2000" class="border p-2 rounded-lg w-full text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="packaging" class="block font-medium text-gray-700 mb-1">Packaging (₹)</label>
                            <input type="number" id="packaging" min="0" max="500" step="5" value="0" class="border p-2 rounded-lg w-full text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="loading" class="block font-medium text-gray-700 mb-1">Loading (₹)</label>
                            <input type="number" id="loading" min="0" max="500" step="5" value="0" class="border p-2 rounded-lg w-full text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="other" class="block font-medium text-gray-700 mb-1">Other (₹)</label>
                            <input type="number" id="other" min="0" max="500" step="5" value="0" class="border p-2 rounded-lg w-full text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="defect_percent" class="block font-medium text-gray-700 mb-1">Defect Rate (%)</label>
                            <input type="number" id="defect_percent" min="0" max="100" step="1" value="0" class="border p-2 rounded-lg w-full text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="advance_amount" class="block font-medium text-gray-700 mb-1">Advance Amount (₹)</label>
                            <input type="number" id="advance_amount" min="0" max="200000" step="100" value="100000" class="border p-2 rounded-lg w-full text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>
            </section>

            <section id="outputs" class="lg:col-span-3 space-y-8">
                
                <div id="kpis" class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="bg-white p-4 rounded-2xl shadow-lg text-center">
                        <h3 class="text-md font-medium text-gray-500">Gross Profit</h3>
                        <p id="kpi_gross_profit" class="text-3xl font-bold text-green-600">₹48,000.00</p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-lg text-center">
                        <h3 class="text-md font-medium text-gray-500">Profit Margin</h3>
                        <p id="kpi_profit_margin" class="text-3xl font-bold text-green-600">6.33%</p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-lg text-center">
                        <h3 class="text-md font-medium text-gray-500">Breakeven Price/pc</h3>
                        <p id="kpi_breakeven_price" class="text-3xl font-bold text-orange-600">₹710.04</p>
                    </div>
                </div>

                <div id="visualizations" class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4 text-center text-gray-700">Landed Cost Breakdown</h3>
                        <p class="text-center text-sm text-gray-500 mb-4">This chart shows the proportion of each component contributing to your total landed cost.</p>
                        <div class="chart-container">
                            <canvas id="costBreakdownChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4 text-center text-gray-700">Revenue vs. Cost</h3>
                        <p class="text-center text-sm text-gray-500 mb-4">This chart compares your total adjusted revenue against the total landed cost to show profitability.</p>
                        <div class="chart-container">
                            <canvas id="revenueCostChart"></canvas>
                        </div>
                    </div>
                </div>

                <div id="details" class="bg-white p-6 rounded-2xl shadow-lg">
                    <h3 class="text-xl font-bold mb-4 text-gray-700">Detailed Calculation</h3>
                     <p class="text-sm text-gray-500 mb-4">Here is the line-by-line breakdown of all calculations based on your inputs.</p>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <tbody class="divide-y divide-gray-200">
                                <tr class="hover:bg-gray-50"><td class="py-3 px-2 font-medium">Purchase Subtotal</td><td id="output_purchase_subtotal" class="py-3 px-2 text-right font-semibold">₹6,00,000.00</td></tr>
                                <tr class="hover:bg-gray-50"><td class="py-3 px-2 font-medium">GST Amount</td><td id="output_gst_amount" class="py-3 px-2 text-right font-semibold">₹1,08,000.00</td></tr>
                                <tr class="bg-gray-100 font-bold"><td class="py-3 px-2">Landed Cost (Total)</td><td id="output_landed_cost_total" class="py-3 px-2 text-right">₹7,10,035.00</td></tr>
                                <tr class="hover:bg-gray-50"><td class="py-3 px-2 font-medium">Landed Cost/pc</td><td id="output_landed_cost_pc" class="py-3 px-2 text-right font-semibold">₹710.04</td></tr>
                                <tr class="hover:bg-gray-50"><td class="py-3 px-2 font-medium">Sales Revenue (Gross)</td><td id="output_sales_revenue" class="py-3 px-2 text-right font-semibold">₹7,73,505.10</td></tr>
                                <tr class="hover:bg-gray-50"><td class="py-3 px-2 font-medium">Total Quantity</td><td id="output_total_quantity" class="py-3 px-2 text-right font-semibold">1000</td></tr>
                                <tr class="hover:bg-gray-50"><td class="py-3 px-2 font-medium">Expected Defect Qty</td><td id="output_defect_qty" class="py-3 px-2 text-right font-semibold">20</td></tr>
                                <tr class="hover:bg-gray-50"><td class="py-3 px-2 font-medium">Net Saleable Qty</td><td id="output_net_saleable_qty" class="py-3 px-2 text-right font-semibold">980</td></tr>
                                <tr class="bg-gray-100 font-bold"><td class="py-3 px-2">Adjusted Sales Revenue</td><td id="output_adjusted_sales_revenue" class="py-3 px-2 text-right">₹7,58,035.10</td></tr>
                                <tr class="bg-green-50 font-bold"><td class="py-3 px-2 text-green-800">Gross Profit</td><td id="output_gross_profit" class="py-3 px-2 text-right text-green-800">₹48,000.00</td></tr>
                                <tr class="bg-green-50 font-bold"><td class="py-3 px-2 text-green-800">Profit Margin %</td><td id="output_profit_margin" class="py-3 px-2 text-right text-green-800">6.33%</td></tr>
                                <tr class="bg-orange-50 font-bold"><td class="py-3 px-2 text-orange-800">Breakeven Selling Price/pc</td><td id="output_breakeven_price" class="py-3 px-2 text-right text-orange-800">₹710.04</td></tr>
                                <tr class="hover:bg-gray-50"><td class="py-3 px-2 font-medium">Advance Amount</td><td id="output_advance_amount" class="py-3 px-2 text-right font-semibold">₹1,00,000.00</td></tr>
                                <tr class="bg-blue-50 font-bold"><td class="py-3 px-2 text-blue-800">Balance Payable by Customer</td><td id="output_balance_payable" class="py-3 px-2 text-right text-blue-800">₹6,58,035.10</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Updated state to handle multiple sizes as an array, each with its own selling price
        const state = {
            sizes: [
                // NEW DEFAULT VALUES BASED ON USER REQUEST
                { id: 1, size: '30', quantity: 200, factory_price: 600, selling_price: 650 },
                { id: 2, size: '32', quantity: 200, factory_price: 650, selling_price: 700 },
                { id: 3, size: '34', quantity: 200, factory_price: 700, selling_price: 750 },
                { id: 4, size: '36', quantity: 200, factory_price: 750, selling_price: 800 },
                { id: 5, size: '38', quantity: 100, factory_price: 800, selling_price: 850 },
                { id: 6, size: '40', quantity: 100, factory_price: 850, selling_price: 900 }
            ],
            gst_percent: 0,
            transport: 2000,
            packaging: 0,
            loading: 0,
            other: 0,
            defect_percent: 0,
            advance_amount: 100000,
        };

        const calculations = {};
        const commonInputIds = ['gst_percent', 'transport', 'packaging', 'loading', 'other', 'defect_percent', 'advance_amount'];
        
        let costBreakdownChart, revenueCostChart;
        let sizeIdCounter = 7; // Start counter after the new defaults

        function formatCurrency(value) {
            return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 2 }).format(value);
        }

        function calculate() {
            const s = state;
            const c = calculations;
            const defectRate = s.defect_percent / 100;
            const gstRate = s.gst_percent / 100;

            // Calculate totals from all sizes
            c.purchase_subtotal = s.sizes.reduce((sum, size) => sum + (size.quantity * size.factory_price), 0);
            c.total_quantity = s.sizes.reduce((sum, size) => sum + size.quantity, 0);

            c.gst_amount = c.purchase_subtotal * gstRate;
            c.landed_cost_total = c.purchase_subtotal + c.gst_amount + s.transport + s.packaging + s.loading + s.other;
            c.landed_cost_pc = c.total_quantity > 0 ? (c.landed_cost_total / c.total_quantity) : 0;
            
            // Calculate gross sales revenue by summing revenue for each size
            c.sales_revenue_gross = s.sizes.reduce((sum, size) => sum + (size.quantity * size.selling_price), 0);

            c.expected_defect_qty = Math.round(c.total_quantity * defectRate);
            c.net_saleable_qty = c.total_quantity - c.expected_defect_qty;
            
            // Calculate adjusted sales revenue by applying defect rate to the total gross revenue
            c.adjusted_sales_revenue = c.sales_revenue_gross * (1 - defectRate);
            
            c.gross_profit = c.adjusted_sales_revenue - c.landed_cost_total;
            c.profit_margin = c.adjusted_sales_revenue > 0 ? (c.gross_profit / c.adjusted_sales_revenue) : 0;
            c.breakeven_price = c.landed_cost_pc;
            c.advance_amount = s.advance_amount;
            c.balance_payable = c.adjusted_sales_revenue - c.advance_amount;
        }

        function updateUI() {
            const c = calculations;
            
            document.getElementById('kpi_gross_profit').textContent = formatCurrency(c.gross_profit);
            document.getElementById('kpi_profit_margin').textContent = `${(c.profit_margin * 100).toFixed(2)}%`;
            document.getElementById('kpi_breakeven_price').textContent = formatCurrency(c.breakeven_price);

            document.getElementById('output_purchase_subtotal').textContent = formatCurrency(c.purchase_subtotal);
            document.getElementById('output_gst_amount').textContent = formatCurrency(c.gst_amount);
            document.getElementById('output_landed_cost_total').textContent = formatCurrency(c.landed_cost_total);
            document.getElementById('output_landed_cost_pc').textContent = formatCurrency(c.landed_cost_pc);
            document.getElementById('output_sales_revenue').textContent = formatCurrency(c.sales_revenue_gross);
            document.getElementById('output_total_quantity').textContent = c.total_quantity;
            document.getElementById('output_defect_qty').textContent = c.expected_defect_qty;
            document.getElementById('output_net_saleable_qty').textContent = c.net_saleable_qty;
            document.getElementById('output_adjusted_sales_revenue').textContent = formatCurrency(c.adjusted_sales_revenue);
            document.getElementById('output_gross_profit').textContent = formatCurrency(c.gross_profit);
            document.getElementById('output_profit_margin').textContent = `${(c.profit_margin * 100).toFixed(2)}%`;
            document.getElementById('output_breakeven_price').textContent = formatCurrency(c.breakeven_price);
            document.getElementById('output_advance_amount').textContent = formatCurrency(c.advance_amount);
            document.getElementById('output_balance_payable').textContent = formatCurrency(c.balance_payable);

            updateCharts();
        }

        function updateCharts() {
            const s = state;
            const c = calculations;

            costBreakdownChart.data.datasets[0].data = [
                c.purchase_subtotal,
                c.gst_amount,
                s.transport,
                s.packaging,
                s.loading,
                s.other
            ];
            costBreakdownChart.update();

            revenueCostChart.data.datasets[0].data = [c.adjusted_sales_revenue];
            revenueCostChart.data.datasets[1].data = [c.landed_cost_total];
            revenueCostChart.update();
        }

        function renderSizeInputs() {
            const container = document.getElementById('size-table-body');
            container.innerHTML = '';
            state.sizes.forEach(sizeItem => {
                const row = document.createElement('tr');
                row.className = "hover:bg-gray-50";
                row.innerHTML = `
                    <td class="p-2 border-b">
                        <input type="text" value="${sizeItem.size}" class="w-full text-center border rounded-lg p-1" data-id="${sizeItem.id}" data-key="size">
                    </td>
                    <td class="p-2 border-b">
                        <input type="number" min="1" value="${sizeItem.quantity}" class="w-full text-center border rounded-lg p-1" data-id="${sizeItem.id}" data-key="quantity">
                    </td>
                    <td class="p-2 border-b">
                        <input type="number" min="1" step="0.5" value="${sizeItem.factory_price}" class="w-full text-center border rounded-lg p-1" data-id="${sizeItem.id}" data-key="factory_price">
                    </td>
                     <!-- NEW SELLING PRICE INPUT -->
                     <td class="p-2 border-b">
                        <input type="number" min="1" step="0.5" value="${sizeItem.selling_price}" class="w-full text-center border rounded-lg p-1" data-id="${sizeItem.id}" data-key="selling_price">
                    </td>
                    <td class="p-2 border-b">
                        <button class="remove-size-btn text-red-500 hover:text-red-700 font-bold" data-id="${sizeItem.id}">
                            &times;
                        </button>
                    </td>
                `;
                container.appendChild(row);
            });
        }
        
        function setupEventListeners() {
            // Event listeners for common inputs
            commonInputIds.forEach(id => {
                const element = document.getElementById(id);
                element.addEventListener('input', (e) => {
                    let value = parseFloat(e.target.value);
                    if (e.target.id === 'gst_percent' || e.target.id === 'defect_percent') {
                        state[id] = value;
                    } else if (value || value === 0) {
                        state[id] = value;
                    }
                    calculate();
                    updateUI();
                });
            });

            // Event listeners for dynamic size inputs
            document.getElementById('size-table-body').addEventListener('input', (e) => {
                const target = e.target;
                if (target.tagName === 'INPUT') {
                    const id = parseInt(target.dataset.id);
                    const key = target.dataset.key;
                    const value = key === 'size' ? target.value : parseFloat(target.value);
                    const sizeItem = state.sizes.find(item => item.id === id);
                    if (sizeItem) {
                        sizeItem[key] = value;
                        calculate();
                        updateUI();
                    }
                }
            });

            // Add size button
            document.getElementById('add-size-btn').addEventListener('click', () => {
                sizeIdCounter++;
                // Set default values for the new row
                state.sizes.push({ id: sizeIdCounter, size: '', quantity: 0, factory_price: 0, selling_price: 0 });
                renderSizeInputs();
                calculate();
                updateUI();
            });

            // Remove size button
            document.getElementById('size-table-body').addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-size-btn')) {
                    const id = parseInt(e.target.dataset.id);
                    state.sizes = state.sizes.filter(item => item.id !== id);
                    renderSizeInputs();
                    calculate();
                    updateUI();
                }
            });
        }
        
        function initCharts() {
            const costCtx = document.getElementById('costBreakdownChart').getContext('2d');
            costBreakdownChart = new Chart(costCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Purchase Subtotal', 'GST', 'Transport', 'Packaging', 'Loading', 'Other'],
                    datasets: [{
                        data: [],
                        backgroundColor: ['#4A5568', '#718096', '#A0AEC0', '#CBD5E0', '#E2E8F0', '#EDF2F7'],
                        borderColor: '#FDFBF7',
                        borderWidth: 4,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += formatCurrency(context.parsed);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });

            const revenueCtx = document.getElementById('revenueCostChart').getContext('2d');
            revenueCostChart = new Chart(revenueCtx, {
                type: 'bar',
                data: {
                    labels: ['Comparison'],
                    datasets: [
                        {
                            label: 'Adjusted Sales Revenue',
                            data: [],
                            backgroundColor: 'rgba(52, 211, 153, 0.7)',
                            borderColor: 'rgba(5, 150, 105, 1)',
                            borderWidth: 2,
                            borderRadius: 6,
                        },
                        {
                            label: 'Landed Cost (Total)',
                            data: [],
                            backgroundColor: 'rgba(239, 68, 68, 0.7)',
                            borderColor: 'rgba(185, 28, 28, 1)',
                            borderWidth: 2,
                            borderRadius: 6,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    },
                    plugins: {
                         legend: {
                            position: 'bottom',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatCurrency(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        window.onload = () => {
            renderSizeInputs();
            setupEventListeners();
            initCharts();
            calculate();
            updateUI();
        };
    </script>
</body>
</html>
